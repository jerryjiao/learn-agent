# ============================================================================
# Langfuse Docker Compose 配置文件 v3
# ============================================================================
# 
# 📘 项目介绍
# ----------------------------------------------------------------------------
# Langfuse 是一个开源的 LLM 工程平台，专注于 AI 应用的可观测性和评估
# 
# 核心功能：
# ✓ 追踪与监控：记录每次 LLM 调用的完整生命周期
# ✓ 提示词管理：版本控制、A/B 测试、提示词优化
# ✓ 评估与标注：自动化评估和人工标注
# ✓ 数据集管理：构建和维护测试数据集
# ✓ 成本分析：Token 使用统计和费用追踪
# ✓ 性能监控：延迟分析和错误追踪
#
# 🏗️ 架构组件说明
# ----------------------------------------------------------------------------
# 服务名称          | 职责                    | 端口        | 资源需求
# -----------------|------------------------|-------------|------------------
# langfuse-web     | Web UI + REST API     | 3000        | 2GB 内存
# langfuse-worker  | 后台任务处理器          | 3030        | 2GB 内存  
# postgres         | 关系型数据库(元数据)    | 5432        | 2GB 内存, 20GB 磁盘
# clickhouse       | 列式数据库(追踪数据)    | 8123, 9000  | 4GB 内存, 100GB 磁盘
# redis            | 缓存与队列             | 6379        | 1GB 内存
# minio            | 对象存储(S3兼容)        | 9090, 9091  | 1GB 内存, 50GB 磁盘
#
# 🔒 安全警告
# ----------------------------------------------------------------------------
# ⚠️ 生产环境部署前必须完成以下安全配置：
#
# 1. 修改所有默认密码和密钥（标记为 # CHANGEME 的配置项）
# 2. 启用 HTTPS（使用 Nginx 或 Caddy 反向代理）
# 3. 配置防火墙，仅开放必要端口（3000, 443）
# 4. 启用 Redis TLS 加密连接
# 5. 定期备份数据库和对象存储
# 6. 设置监控告警系统
#
# 📚 参考文档
# ----------------------------------------------------------------------------
# 官方部署指南：https://langfuse.com/self-hosting/deployment/docker-compose
# 配置说明：    https://langfuse.com/self-hosting/configuration
# 扩容指南：    https://langfuse.com/self-hosting/configuration/scaling
#
# ============================================================================

services:
  # ==========================================================================
  # Langfuse Worker 服务 - 异步任务处理引擎
  # ==========================================================================
  # 
  # 📌 核心职责
  # ----------------------------------------------------------------------------
  # 1. 数据摄入处理：接收并处理来自 SDK 的追踪数据
  # 2. 批量写入优化：批量聚合数据写入 ClickHouse，提升性能
  # 3. 异步任务执行：处理耗时操作（数据导出、评估计算等）
  # 4. 定时任务调度：数据清理、统计聚合等周期性任务
  #
  # ⚙️ 工作原理
  # ----------------------------------------------------------------------------
  # Web 服务接收到追踪数据后，将任务发送到 Redis 队列
  # Worker 从队列中获取任务，处理后写入 ClickHouse 和 PostgreSQL
  # 这种架构实现了请求处理与数据写入的解耦，提升整体吞吐量
  #
  # 🔧 技术特性
  # ----------------------------------------------------------------------------
  # - 水平扩展：可启动多个 Worker 实例并行处理任务
  # - 容错处理：任务失败自动重试，确保数据不丢失
  # - 流量控制：支持限流和批量处理，避免数据库过载
  #
  # 📊 性能调优
  # ----------------------------------------------------------------------------
  # 环境变量 LANGFUSE_INGESTION_QUEUE_DELAY_MS 控制任务处理延迟
  # 环境变量 LANGFUSE_INGESTION_CLICKHOUSE_WRITE_INTERVAL_MS 控制批量写入间隔
  # 增大这些值可提高吞吐量，但会增加数据延迟
  #
  # ==========================================================================
  langfuse-worker:
    # 容器镜像：使用官方 Worker 镜像 v3 版本
    # 镜像仓库：Docker Hub (docker.io)
    # 更新策略：定期检查新版本 (docker compose pull)
    image: docker.io/langfuse/langfuse-worker:3
    
    # 重启策略：容器异常退出时自动重启
    # 其他选项：no (不重启), on-failure (仅失败时重启), unless-stopped (手动停止前一直重启)
    restart: always
    
    # 服务依赖声明：Worker 必须等待所有依赖服务健康后才能启动
    # 使用 YAML 锚点 (&langfuse-depends-on) 定义依赖列表，供 langfuse-web 复用
    # condition: service_healthy 确保依赖服务通过健康检查后才启动
    depends_on: &langfuse-depends-on
      postgres:
        condition: service_healthy  # 等待 PostgreSQL 健康检查通过
      minio:
        condition: service_healthy  # 等待 MinIO 健康检查通过
      redis:
        condition: service_healthy  # 等待 Redis 健康检查通过
      clickhouse:
        condition: service_healthy  # 等待 ClickHouse 健康检查通过
    
    # 端口映射：格式为 "宿主机IP:宿主机端口:容器端口"
    # 127.0.0.1:3030:3030 表示仅本机可访问，用于健康检查和内部监控
    # 不建议对外开放此端口，避免安全风险
    ports:
      - 127.0.0.1:3030:3030
    
    # ========================================================================
    # 环境变量配置（使用 YAML 锚点 &langfuse-worker-env 定义）
    # ========================================================================
    # 说明：此配置块会被 langfuse-web 服务继承复用
    # 语法：${变量名:-默认值} 表示优先读取 .env 文件，否则使用默认值
    # ========================================================================
    environment: &langfuse-worker-env
      # ======================================================================
      # 🔐 核心认证与安全配置
      # ======================================================================
      
      # NextAuth 应用访问 URL（用于 OAuth 认证回调和会话管理）
      # ----------------------------------------------------------------------
      # 说明：此 URL 用于生成认证回调链接和会话 Cookie
      # 开发环境：http://localhost:3000
      # 生产环境：https://langfuse.yourdomain.com
      # ⚠️ 必须与实际访问地址一致，否则认证会失败
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      
      # PostgreSQL 数据库连接字符串（主数据库）
      # ----------------------------------------------------------------------
      # 格式：postgresql://用户名:密码@主机:端口/数据库名
      # 说明：存储用户信息、项目配置、权限数据等核心元数据
      # ⚠️ CHANGEME: 生产环境必须修改密码部分！
      # 推荐：使用连接池（如 PgBouncer）提升性能
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/postgres}
      
      # 加密盐值（用于密码哈希和数据加盐）
      # ----------------------------------------------------------------------
      # 说明：与密码哈希算法配合使用，增强安全性
      # ⚠️ CHANGEME: 生产环境必须使用长随机字符串（建议 ≥ 32 字符）
      # 生成方式：openssl rand -base64 32
      # ⚠️ 警告：修改此值会导致现有用户无法登录！
      SALT: ${SALT:-mysalt}
      
      # 数据加密密钥（AES-256 加密算法）
      # ----------------------------------------------------------------------
      # 说明：用于加密存储的敏感数据（API 密钥、OAuth Token 等）
      # ⚠️ CHANGEME: 必须是 64 位十六进制字符串（256 bit = 32 bytes = 64 hex chars）
      # 生成方式：openssl rand -hex 32
      # ⚠️ 警告：修改此值会导致已加密数据无法解密！
      # 示例：a1b2c3d4e5f6...（共 64 个十六进制字符）
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-0000000000000000000000000000000000000000000000000000000000000000}
      
      # 匿名遥测数据收集开关（帮助改进产品）
      # ----------------------------------------------------------------------
      # 说明：收集匿名使用统计（功能使用频率、错误日志等）
      # 数据用途：产品改进、功能优先级决策
      # 隐私说明：不包含任何敏感信息或个人数据
      # 设置为 false 可完全禁用遥测功能
      TELEMETRY_ENABLED: ${TELEMETRY_ENABLED:-true}
      
      # 实验性功能开关（Beta 功能和新特性）
      # ----------------------------------------------------------------------
      # 说明：启用后可使用 UI 中标记为 "Experimental" 的功能
      # 开发环境：建议设为 true，体验最新功能
      # 生产环境：建议设为 false，确保稳定性
      # 功能示例：新的评估算法、UI 改进等
      LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: ${LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES:-true}
      
      # ======================================================================
      # 📊 ClickHouse 配置 - 高性能列式分析数据库
      # ======================================================================
      # 
      # 🎯 为什么使用 ClickHouse？
      # ----------------------------------------------------------------------
      # ClickHouse 是专为 OLAP（在线分析处理）设计的列式数据库
      # 相比传统行式数据库（如 PostgreSQL），在分析查询场景下性能提升 10-100 倍
      # 
      # 数据分工：
      # - PostgreSQL：存储元数据（用户、项目、配置等）- 小数据量，频繁更新
      # - ClickHouse：存储追踪数据（Trace, Span, Event）- 大数据量，追加写入，聚合查询
      #
      # 性能优势：
      # - 列式存储：只读取需要的列，减少 I/O
      # - 数据压缩：压缩比高达 10:1，节省存储空间
      # - 向量化执行：批量处理数据，充分利用 CPU
      # - 分布式查询：支持多节点并行处理
      # ----------------------------------------------------------------------
      
      # ClickHouse 数据库迁移连接 URL（使用原生 TCP 协议）
      # ----------------------------------------------------------------------
      # 协议：clickhouse:// (原生 TCP 协议，端口 9000)
      # 用途：执行数据库 Schema 迁移（CREATE TABLE, ALTER TABLE 等）
      # 说明：迁移操作通常使用原生协议，性能更好
      CLICKHOUSE_MIGRATION_URL: ${CLICKHOUSE_MIGRATION_URL:-clickhouse://clickhouse:9000}
      
      # ClickHouse HTTP API 连接 URL（用于查询和数据写入）
      # ----------------------------------------------------------------------
      # 协议：http:// 或 https:// (HTTP API，端口 8123 或 8443)
      # 用途：日常数据查询和写入操作
      # 说明：HTTP API 更通用，支持防火墙穿透，便于集成
      CLICKHOUSE_URL: ${CLICKHOUSE_URL:-http://clickhouse:8123}
      
      # ClickHouse 数据库用户名
      # ----------------------------------------------------------------------
      # 说明：需要具备 SELECT, INSERT, CREATE, ALTER, DELETE 权限
      # 安全建议：生产环境创建专用用户，避免使用 default 用户
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-clickhouse}
      
      # ClickHouse 数据库密码
      # ----------------------------------------------------------------------
      # ⚠️ CHANGEME: 生产环境必须修改强密码！
      # 安全建议：≥ 16 字符，包含大小写字母、数字、特殊字符
      # 生成方式：openssl rand -base64 24
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
      
      # ClickHouse 集群模式开关
      # ----------------------------------------------------------------------
      # 说明：控制是否使用 ON CLUSTER 语法执行 DDL 操作
      # false (默认)：单机部署，适合开发和小规模生产环境
      # true：集群部署，DDL 会在所有节点执行，适合大规模生产环境
      # 
      # 何时启用集群模式：
      # - 数据量 > 1TB
      # - QPS > 10000
      # - 需要高可用和容错
      CLICKHOUSE_CLUSTER_ENABLED: ${CLICKHOUSE_CLUSTER_ENABLED:-false}
      
      # ======================================================================
      # 💾 对象存储配置 - 事件数据存储 (Event Upload)
      # ======================================================================
      #
      # 📘 存储架构说明
      # ----------------------------------------------------------------------
      # Langfuse v3 引入了混合存储架构，数据分层存储：
      # 
      # 1. 热数据（PostgreSQL）：最近的元数据，快速访问
      # 2. 温数据（ClickHouse）：追踪数据，聚合查询
      # 3. 冷数据（S3/MinIO）：原始事件数据，长期归档
      #
      # 为什么使用对象存储？
      # - 成本低：相比数据库存储成本降低 90%
      # - 扩展性强：支持 PB 级数据存储
      # - 持久性高：多副本或纠删码保证数据安全
      # ----------------------------------------------------------------------
      
      # 是否使用 Azure Blob Storage（false 表示使用 S3 兼容存储）
      # ----------------------------------------------------------------------
      # false：使用 S3 兼容存储（MinIO, AWS S3, 阿里云 OSS, 腾讯云 COS 等）
      # true：使用 Azure Blob Storage（需配置相应的 Azure 环境变量）
      LANGFUSE_USE_AZURE_BLOB: ${LANGFUSE_USE_AZURE_BLOB:-false}
      
      # S3 存储桶名称（用于存储事件数据）
      # ----------------------------------------------------------------------
      # 说明：事件数据包括完整的追踪 Payload、LLM 请求/响应等
      # 建议：生产环境使用独立存储桶，便于管理和权限控制
      LANGFUSE_S3_EVENT_UPLOAD_BUCKET: ${LANGFUSE_S3_EVENT_UPLOAD_BUCKET:-langfuse}
      
      # S3 区域设置
      # ----------------------------------------------------------------------
      # MinIO：使用 auto（自动检测）
      # AWS S3：使用实际区域，如 us-east-1, ap-northeast-1
      # 阿里云 OSS：使用 oss-cn-hangzhou, oss-cn-shanghai 等
      # 腾讯云 COS：使用 ap-guangzhou, ap-shanghai 等
      LANGFUSE_S3_EVENT_UPLOAD_REGION: ${LANGFUSE_S3_EVENT_UPLOAD_REGION:-auto}
      
      # S3 访问密钥 ID (Access Key ID)
      # ----------------------------------------------------------------------
      # MinIO：对应 MINIO_ROOT_USER
      # AWS S3：IAM 用户的 Access Key ID
      # 权限要求：s3:PutObject, s3:GetObject, s3:ListBucket
      LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: ${LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID:-minio}
      
      # S3 访问密钥 (Secret Access Key)
      # ----------------------------------------------------------------------
      # MinIO：对应 MINIO_ROOT_PASSWORD
      # AWS S3：IAM 用户的 Secret Access Key
      # ⚠️ CHANGEME: 生产环境必须修改！
      # 安全建议：使用 IAM Role 或临时凭证，避免硬编码密钥
      LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: ${LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY:-miniosecret}
      
      # S3 服务端点（内部访问地址）
      # ----------------------------------------------------------------------
      # MinIO：http://minio:9000（Docker 网络内部地址）
      # AWS S3：留空（使用默认端点）或 https://s3.amazonaws.com
      # 阿里云 OSS：http://oss-cn-hangzhou.aliyuncs.com
      # 腾讯云 COS：http://cos.ap-guangzhou.myqcloud.com
      # 说明：此端点用于 Worker 写入数据，不需要公网访问
      LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: ${LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT:-http://minio:9000}
      
      # 强制使用路径样式访问（Path-Style）
      # ----------------------------------------------------------------------
      # true：路径样式  → http://endpoint/bucket/key
      # false：虚拟主机样式 → http://bucket.endpoint/key
      # 
      # 何时设为 true：
      # - 使用 MinIO（必须）
      # - 使用自定义域名
      # - 存储桶名称包含点号（.）
      LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: ${LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE:-true}
      
      # 事件数据在存储桶中的前缀路径
      # ----------------------------------------------------------------------
      # 说明：所有事件数据将存储在 {bucket}/{prefix}{object_key} 路径下
      # 示例：langfuse/events/2025/01/22/trace_abc123.json
      # 用途：实现数据分类、权限隔离、生命周期管理
      # 注意：前缀必须以 / 结尾
      LANGFUSE_S3_EVENT_UPLOAD_PREFIX: ${LANGFUSE_S3_EVENT_UPLOAD_PREFIX:-events/}
      
      # ======================================================================
      # 🖼️ 对象存储配置 - 媒体文件上传 (Media Upload)
      # ======================================================================
      #
      # 📘 功能说明
      # ----------------------------------------------------------------------
      # 支持在追踪数据中关联多模态媒体文件：
      # - 图片：截图、可视化图表、UI 界面
      # - 音频：语音输入、TTS 输出
      # - 视频：演示录屏、监控视频
      # - 文档：PDF、Word、Excel 等
      #
      # 🔄 上传流程
      # ----------------------------------------------------------------------
      # 1. 客户端向 Langfuse Web 请求预签名上传 URL
      # 2. Web 服务生成临时上传凭证（有效期 15 分钟）
      # 3. 客户端直接上传文件到对象存储（不经过 Langfuse 服务器）
      # 4. 上传完成后，客户端通知 Langfuse 关联文件到追踪数据
      #
      # 优势：
      # - 减轻服务器负担（不占用带宽）
      # - 提升上传速度（直连对象存储）
      # - 支持大文件上传（GB 级别）
      # ----------------------------------------------------------------------
      
      # 媒体文件存储桶名称
      # ----------------------------------------------------------------------
      # 说明：可与事件数据共用同一桶（通过前缀区分）
      # 建议：生产环境使用独立存储桶，配置独立的访问策略
      LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: ${LANGFUSE_S3_MEDIA_UPLOAD_BUCKET:-langfuse}
      
      # 媒体存储区域
      # ----------------------------------------------------------------------
      # 说明：同事件存储配置，保持一致即可
      LANGFUSE_S3_MEDIA_UPLOAD_REGION: ${LANGFUSE_S3_MEDIA_UPLOAD_REGION:-auto}
      
      # 媒体存储访问密钥 ID
      # ----------------------------------------------------------------------
      # 说明：用于生成预签名 URL，需要 PutObject 权限
      LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: ${LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID:-minio}
      
      # 媒体存储访问密钥
      # ----------------------------------------------------------------------
      # ⚠️ CHANGEME: 生产环境必须修改！
      # 安全建议：创建专用子账号，仅授予媒体存储桶的读写权限
      LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: ${LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY:-miniosecret}
      
      # 媒体存储外部端点（用于生成预签名 URL 和客户端直接上传）
      # ----------------------------------------------------------------------
      # ⚠️ 重要：此端点必须是客户端浏览器可访问的地址！
      # 
      # 本地部署：http://localhost:9090
      # 云服务器：http://<服务器公网IP>:9090 或 https://minio.yourdomain.com
      # 
      # 说明：
      # - Web 服务使用此端点生成预签名 URL
      # - 客户端浏览器使用此 URL 直接上传文件
      # - 如果端点不可达，文件上传会失败
      #
      # 安全建议：
      # - 生产环境使用 HTTPS 加密传输
      # - 配置 CORS 策略，限制来源域名
      # - 启用防盗链（Referer 白名单）
      LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: ${LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT:-http://localhost:9090}
      
      # 强制路径样式访问
      # ----------------------------------------------------------------------
      # 说明：MinIO 必须设为 true
      LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: ${LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE:-true}
      
      # 媒体文件存储路径前缀
      # ----------------------------------------------------------------------
      # 说明：媒体文件存储在 {bucket}/{prefix}{file_id}.{ext} 路径下
      # 示例：langfuse/media/2025/01/22/img_abc123.png
      # 用途：分类管理、权限隔离、CDN 加速
      LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: ${LANGFUSE_S3_MEDIA_UPLOAD_PREFIX:-media/}
      
      # ======================================================================
      # 📦 对象存储配置 - 批量数据导出 (Batch Export)
      # ======================================================================
      #
      # 📘 功能说明
      # ----------------------------------------------------------------------
      # 允许用户将追踪数据批量导出为结构化文件，用于：
      # - 离线分析：使用 Python/R 进行深度数据分析
      # - 数据备份：定期导出重要数据作为灾备
      # - 合规要求：满足数据审计和留存要求
      # - 系统迁移：迁移到其他平台或自建系统
      #
      # 支持格式：
      # - JSON：完整数据结构，适合程序处理
      # - CSV：表格数据，适合 Excel 分析
      # - Parquet：列式存储，适合大数据处理
      #
      # 🔄 导出流程
      # ----------------------------------------------------------------------
      # 1. 用户在 UI 中选择数据范围和格式
      # 2. Worker 从数据库读取数据，分页处理（避免内存溢出）
      # 3. 数据写入对象存储
      # 4. 生成预签名下载 URL（有效期 1 小时）
      # 5. 用户点击下载链接获取文件
      #
      # 性能参数：
      # - BATCH_EXPORT_PAGE_SIZE：每页 500 条记录
      # - BATCH_EXPORT_ROW_LIMIT：单次最多导出 150 万条记录
      # ----------------------------------------------------------------------
      
      # 是否启用批量导出功能
      # ----------------------------------------------------------------------
      # false（默认）：禁用导出功能，节省存储空间
      # true：启用导出功能，需要配置对象存储
      # 建议：开发环境可禁用，生产环境建议启用
      LANGFUSE_S3_BATCH_EXPORT_ENABLED: ${LANGFUSE_S3_BATCH_EXPORT_ENABLED:-false}
      
      # 导出文件存储桶名称
      # ----------------------------------------------------------------------
      # 说明：可与其他数据共用存储桶（通过前缀区分）
      LANGFUSE_S3_BATCH_EXPORT_BUCKET: ${LANGFUSE_S3_BATCH_EXPORT_BUCKET:-langfuse}
      
      # 导出文件存储路径前缀
      # ----------------------------------------------------------------------
      # 说明：导出文件存储在 {bucket}/{prefix}{export_id}.{format}
      # 示例：langfuse/exports/2025-01-22/export_abc123.json
      LANGFUSE_S3_BATCH_EXPORT_PREFIX: ${LANGFUSE_S3_BATCH_EXPORT_PREFIX:-exports/}
      
      # 导出存储区域
      LANGFUSE_S3_BATCH_EXPORT_REGION: ${LANGFUSE_S3_BATCH_EXPORT_REGION:-auto}
      
      # 导出存储内部端点（Worker 写入数据使用）
      # ----------------------------------------------------------------------
      # 说明：Worker 服务使用此端点写入导出文件
      # 内部端点：http://minio:9000（Docker 网络内部）
      LANGFUSE_S3_BATCH_EXPORT_ENDPOINT: ${LANGFUSE_S3_BATCH_EXPORT_ENDPOINT:-http://minio:9000}
      
      # 导出存储外部端点（用户下载文件使用）
      # ----------------------------------------------------------------------
      # ⚠️ 重要：此端点用于生成用户下载链接，必须是用户可访问的地址！
      # 
      # 本地部署：http://localhost:9090
      # 云服务器：http://<服务器公网IP>:9090 或 https://minio.yourdomain.com
      #
      # 说明：Web 服务使用此端点生成预签名下载 URL
      LANGFUSE_S3_BATCH_EXPORT_EXTERNAL_ENDPOINT: ${LANGFUSE_S3_BATCH_EXPORT_EXTERNAL_ENDPOINT:-http://localhost:9090}
      
      # 导出存储访问密钥 ID
      LANGFUSE_S3_BATCH_EXPORT_ACCESS_KEY_ID: ${LANGFUSE_S3_BATCH_EXPORT_ACCESS_KEY_ID:-minio}
      
      # 导出存储访问密钥
      # ----------------------------------------------------------------------
      # ⚠️ CHANGEME: 生产环境必须修改！
      LANGFUSE_S3_BATCH_EXPORT_SECRET_ACCESS_KEY: ${LANGFUSE_S3_BATCH_EXPORT_SECRET_ACCESS_KEY:-miniosecret}
      
      # 强制路径样式访问
      LANGFUSE_S3_BATCH_EXPORT_FORCE_PATH_STYLE: ${LANGFUSE_S3_BATCH_EXPORT_FORCE_PATH_STYLE:-true}
      
      # ======================================================================
      # ⚡ 数据摄入队列配置 - 性能调优参数
      # ======================================================================
      #
      # 📘 工作原理
      # ----------------------------------------------------------------------
      # 追踪数据的处理流程：
      # 1. SDK 发送数据到 Web API
      # 2. Web 服务快速响应（200 OK），将任务放入 Redis 队列
      # 3. Worker 从队列取出任务，批量聚合
      # 4. 达到时间阈值或数量阈值时，批量写入 ClickHouse
      #
      # 🎯 调优目标
      # ----------------------------------------------------------------------
      # 低延迟场景：实时监控、快速响应
      # - 减小延迟参数（如 100ms）
      # - 数据快速可见，但写入频繁
      #
      # 高吞吐场景：大规模追踪、成本优化
      # - 增大延迟参数（如 5000ms）
      # - 批量写入，提升吞吐量，降低数据库负载
      # ----------------------------------------------------------------------
      
      # 队列处理延迟（毫秒）
      # ----------------------------------------------------------------------
      # 说明：数据在 Redis 队列中的最大停留时间
      # 默认值：1000ms (1秒)
      # 
      # 调优建议：
      # - 实时监控：500ms
      # - 一般场景：1000ms（默认）
      # - 高吞吐：2000-5000ms
      # 
      # 留空使用默认值
      LANGFUSE_INGESTION_QUEUE_DELAY_MS: ${LANGFUSE_INGESTION_QUEUE_DELAY_MS:-}
      
      # ClickHouse 批量写入间隔（毫秒）
      # ----------------------------------------------------------------------
      # 说明：控制数据批量写入 ClickHouse 的频率
      # 默认值：3000ms (3秒)
      #
      # 调优建议：
      # - 低延迟：1000ms
      # - 一般场景：3000ms（默认）
      # - 高吞吐：5000-10000ms
      #
      # 注意：较大值会增加数据可见延迟，但能显著提升写入性能
      # 留空使用默认值
      LANGFUSE_INGESTION_CLICKHOUSE_WRITE_INTERVAL_MS: ${LANGFUSE_INGESTION_CLICKHOUSE_WRITE_INTERVAL_MS:-}
      
      # ======================================================================
      # 🚀 Redis 配置 - 高性能缓存与队列服务
      # ======================================================================
      #
      # 📘 用途说明
      # ----------------------------------------------------------------------
      # Redis 在 Langfuse 中扮演多个关键角色：
      #
      # 1. 会话缓存：存储用户登录会话，快速验证身份
      # 2. 任务队列：缓冲追踪数据，实现异步处理
      # 3. 速率限制：防止 API 滥用，保护系统稳定
      # 4. 分布式锁：协调多个 Worker 实例的任务分配
      # 5. 临时缓存：缓存热点数据，减轻数据库压力
      #
      # 🔒 安全建议
      # ----------------------------------------------------------------------
      # 1. 设置强密码（REDIS_AUTH）
      # 2. 禁止外网访问（绑定 127.0.0.1）
      # 3. 生产环境启用 TLS 加密
      # 4. 定期更新 Redis 版本，修复安全漏洞
      # ----------------------------------------------------------------------
      
      # Redis 服务器主机名
      # ----------------------------------------------------------------------
      # Docker 网络内：使用服务名 "redis"
      # 外部 Redis：使用 IP 或域名，如 redis.example.com
      REDIS_HOST: ${REDIS_HOST:-redis}
      
      # Redis 服务端口
      # ----------------------------------------------------------------------
      # 默认：6379（标准 Redis 端口）
      # TLS：6380（常用 TLS 端口）
      REDIS_PORT: ${REDIS_PORT:-6379}
      
      # Redis 认证密码
      # ----------------------------------------------------------------------
      # ⚠️ CHANGEME: 生产环境必须修改！
      # 安全建议：≥ 16 字符，包含大小写字母、数字、特殊字符
      # 生成方式：openssl rand -base64 24
      REDIS_AUTH: ${REDIS_AUTH:-myredissecret}
      
      # 是否启用 Redis TLS 加密连接
      # ----------------------------------------------------------------------
      # false（默认）：明文连接，适合内网环境
      # true：TLS 加密，适合生产环境或跨网络访问
      # 
      # 启用 TLS 的好处：
      # - 数据传输加密，防止中间人攻击
      # - 身份验证，确保连接到正确的 Redis 服务器
      # - 合规要求，满足数据安全标准
      REDIS_TLS_ENABLED: ${REDIS_TLS_ENABLED:-false}
      
      # TLS 证书路径（启用 TLS 时需配置）
      # ----------------------------------------------------------------------
      # CA 证书：用于验证 Redis 服务器身份
      # 客户端证书：用于双向认证（可选）
      # 私钥：客户端证书对应的私钥
      REDIS_TLS_CA: ${REDIS_TLS_CA:-/certs/ca.crt}
      REDIS_TLS_CERT: ${REDIS_TLS_CERT:-/certs/redis.crt}
      REDIS_TLS_KEY: ${REDIS_TLS_KEY:-/certs/redis.key}
      
      # ======================================================================
      # 📧 邮件服务配置 - 用户通知与系统告警
      # ======================================================================
      #
      # 📘 功能说明
      # ----------------------------------------------------------------------
      # 配置 SMTP 邮件服务后，Langfuse 可自动发送：
      #
      # 1. 用户管理邮件：
      #    - 团队成员邀请邮件
      #    - 密码重置链接
      #    - 账户激活通知
      #
      # 2. 系统通知邮件：
      #    - 评估任务完成通知
      #    - 数据导出就绪通知
      #    - 配额使用告警
      #
      # 3. 安全告警邮件：
      #    - 异常登录检测
      #    - API 密钥泄露警告
      #    - 权限变更通知
      #
      # 🔧 SMTP 提供商配置示例
      # ----------------------------------------------------------------------
      # 
      # Gmail (需启用应用专用密码):
      # smtp://your_email@gmail.com:app_password@smtp.gmail.com:587
      #
      # Outlook/Office 365:
      # smtp://your_email@outlook.com:password@smtp-mail.outlook.com:587
      #
      # SendGrid:
      # smtp://apikey:SG.your_api_key@smtp.sendgrid.net:587
      #
      # 阿里云邮件推送:
      # smtp://username:password@smtpdm.aliyun.com:465
      #
      # 腾讯企业邮:
      # smtp://your_email@qq.com:password@smtp.exmail.qq.com:465
      #
      # 注意：
      # - 使用 587 端口时通常需要 STARTTLS
      # - 使用 465 端口时使用 SSL/TLS
      # - 建议使用专用邮件发送服务，避免进入垃圾邮件
      # ----------------------------------------------------------------------
      
      # 发件人邮箱地址
      # ----------------------------------------------------------------------
      # 格式：noreply@yourdomain.com 或 Langfuse <noreply@yourdomain.com>
      # 说明：用户收到的邮件显示的发件人地址
      # 建议：使用 noreply 或 no-reply 前缀，表明这是系统自动邮件
      # 留空则禁用邮件功能
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-}
      
      # SMTP 服务器连接 URL
      # ----------------------------------------------------------------------
      # 格式：smtp://username:password@host:port
      # 或：  smtps://username:password@host:port （使用 SSL/TLS）
      # 
      # 参数说明：
      # - username: SMTP 用户名（通常是邮箱地址）
      # - password: SMTP 密码或应用专用密码
      # - host: SMTP 服务器地址
      # - port: SMTP 端口（25, 465, 587）
      #
      # 留空则禁用邮件功能
      SMTP_CONNECTION_URL: ${SMTP_CONNECTION_URL:-}

  # ==========================================================================
  # Langfuse Web 服务 - 主应用服务器
  # ==========================================================================
  #
  # 📌 核心职责
  # ----------------------------------------------------------------------------
  # 1. Web UI 服务：提供用户界面，数据可视化
  # 2. REST API：接收 SDK 请求，提供数据查询接口
  # 3. 认证服务：用户登录、会话管理、权限控制
  # 4. WebSocket：实时数据推送（可选）
  #
  # 🏗️ 技术架构
  # ----------------------------------------------------------------------------
  # - 框架：Next.js (React 全栈框架)
  # - 认证：NextAuth.js (OAuth, Email/Password)
  # - ORM：Prisma (PostgreSQL 数据访问)
  # - API：tRPC (类型安全的 API 层)
  #
  # 🔄 工作流程
  # ----------------------------------------------------------------------------
  # 客户端请求 → Nginx/Caddy (HTTPS) → Langfuse Web (端口 3000)
  #                                    ↓
  #                               验证身份 (NextAuth)
  #                                    ↓
  #                               处理请求 (tRPC API)
  #                                    ↓
  #                      查询数据库 (PostgreSQL/ClickHouse)
  #                                    ↓
  #                            返回响应 (JSON)
  #
  # 📊 性能特性
  # ----------------------------------------------------------------------------
  # - 静态资源缓存：CSS/JS 使用 CDN 加速
  # - API 响应缓存：Redis 缓存热点数据
  # - 数据库连接池：复用连接，减少开销
  # - 懒加载：按需加载组件和数据
  #
  # ==========================================================================
  langfuse-web:
    # 容器镜像：使用官方 Web 镜像 v3 版本
    # 说明：包含 Next.js 应用和所有前端资源
    image: docker.io/langfuse/langfuse:3
    
    # 重启策略：容器异常退出时自动重启
    restart: always
    
    # 服务依赖：复用 Worker 的依赖配置（YAML 别名引用 *langfuse-depends-on）
    # 说明：确保所有数据库服务健康后才启动 Web 服务
    depends_on: *langfuse-depends-on
    
    # 端口映射：将容器 3000 端口映射到主机 3000 端口
    # 说明：此端口对外开放，用户通过浏览器访问
    # 生产环境建议：使用 Nginx/Caddy 反向代理，启用 HTTPS
    ports:
      - 3000:3000
    
    # ========================================================================
    # 环境变量配置
    # ========================================================================
    environment:
      # 继承所有 Worker 环境变量（使用 YAML 合并语法 <<: *）
      # 说明：包括数据库连接、对象存储、Redis 等所有配置
      <<: *langfuse-worker-env
      
      # ======================================================================
      # 🔐 NextAuth 会话管理配置
      # ======================================================================
      
      # NextAuth.js 会话签名密钥（JWT Secret）
      # ----------------------------------------------------------------------
      # 说明：用于签名和加密用户会话 Token (JWT)
      # ⚠️ CHANGEME: 生产环境必须使用强随机字符串！
      # 生成方式：openssl rand -base64 32
      # ⚠️ 警告：修改此值会导致所有用户会话失效，需要重新登录！
      # 
      # 安全要求：
      # - 长度 ≥ 32 字符
      # - 使用随机生成器生成
      # - 定期轮换（建议每年）
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-mysecret}
      
      # ======================================================================
      # 🚀 无头初始化配置 (Headless Initialization)
      # ======================================================================
      #
      # 📘 功能说明
      # ----------------------------------------------------------------------
      # 无头初始化允许在首次启动时自动创建：
      # - 组织 (Organization)
      # - 项目 (Project)
      # - 管理员用户 (Admin User)
      # - API 密钥对 (Public/Secret Key)
      #
      # 🎯 适用场景
      # ----------------------------------------------------------------------
      # ✅ 自动化部署：CI/CD 流程中自动初始化
      # ✅ 测试环境：快速搭建测试环境
      # ✅ 演示环境：Demo 环境快速初始化
      # ❌ 生产环境：建议通过 UI 手动创建（更安全）
      #
      # 🔄 执行逻辑
      # ----------------------------------------------------------------------
      # 1. 检查是否已存在用户，如存在则跳过
      # 2. 创建组织（Organization）
      # 3. 创建项目（Project）
      # 4. 生成 API 密钥对（如未指定）
      # 5. 创建管理员用户并关联到组织
      # 6. 记录初始化日志
      #
      # ⚠️ 注意事项
      # ----------------------------------------------------------------------
      # - 仅在首次启动时执行，后续启动不会重复创建
      # - 密码会以哈希形式存储，符合安全标准
      # - API 密钥对会显示在日志中（首次启动后立即保存）
      # ----------------------------------------------------------------------
      
      # 初始组织 ID（可自定义，留空则自动生成 UUID）
      # 格式：UUID v4，如 a1b2c3d4-e5f6-7890-abcd-ef1234567890
      LANGFUSE_INIT_ORG_ID: ${LANGFUSE_INIT_ORG_ID:-}
      
      # 初始组织名称
      # 示例：My Company, 我的组织, Test Organization
      LANGFUSE_INIT_ORG_NAME: ${LANGFUSE_INIT_ORG_NAME:-}
      
      # 初始项目 ID（可自定义，留空则自动生成 UUID）
      LANGFUSE_INIT_PROJECT_ID: ${LANGFUSE_INIT_PROJECT_ID:-}
      
      # 初始项目名称
      # 示例：Production, Development, 生产环境, 测试项目
      LANGFUSE_INIT_PROJECT_NAME: ${LANGFUSE_INIT_PROJECT_NAME:-}
      
      # 初始项目公钥（Public Key，用于客户端 SDK 认证）
      # ----------------------------------------------------------------------
      # 格式：pk-lf-xxxxxxxxxxxx
      # 说明：留空则自动生成，可在 UI 中查看和复制
      # 用途：客户端代码中引用，可公开（但建议加入环境变量）
      LANGFUSE_INIT_PROJECT_PUBLIC_KEY: ${LANGFUSE_INIT_PROJECT_PUBLIC_KEY:-}
      
      # 初始项目私钥（Secret Key，用于服务端 SDK 认证）
      # ----------------------------------------------------------------------
      # 格式：sk-lf-xxxxxxxxxxxx
      # 说明：留空则自动生成，可在 UI 中查看和复制
      # ⚠️ 警告：私钥必须保密，泄露后需要立即轮换！
      # 用途：服务端代码中引用，严禁公开或提交到代码仓库
      LANGFUSE_INIT_PROJECT_SECRET_KEY: ${LANGFUSE_INIT_PROJECT_SECRET_KEY:-}
      
      # 初始管理员邮箱
      # ----------------------------------------------------------------------
      # 格式：admin@example.com
      # 说明：用于登录和接收系统通知
      # 建议：使用企业邮箱，便于管理和审计
      LANGFUSE_INIT_USER_EMAIL: ${LANGFUSE_INIT_USER_EMAIL:-}
      
      # 初始管理员用户名
      # ----------------------------------------------------------------------
      # 说明：显示在 UI 中的用户名称
      # 示例：Admin, 管理员, John Doe
      LANGFUSE_INIT_USER_NAME: ${LANGFUSE_INIT_USER_NAME:-}
      
      # 初始管理员密码
      # ----------------------------------------------------------------------
      # 说明：用于首次登录，登录后建议立即修改
      # 安全要求：≥ 8 字符，包含大小写字母、数字
      # ⚠️ 建议：首次登录后立即修改密码并启用 2FA（如支持）
      LANGFUSE_INIT_USER_PASSWORD: ${LANGFUSE_INIT_USER_PASSWORD:-}

  # ==========================================================================
  # ClickHouse 服务 - 高性能列式分析数据库
  # ==========================================================================
  #
  # 📌 核心职责
  # ----------------------------------------------------------------------------
  # 1. 追踪数据存储：存储所有 Trace、Span、Event 数据
  # 2. 聚合查询：计算指标、统计数据、趋势分析
  # 3. 时间序列分析：按时间维度查询和可视化
  # 4. 大规模数据扫描：支持 PB 级数据的全表扫描
  #
  # 🎯 为什么选择 ClickHouse？
  # ----------------------------------------------------------------------------
  # 对比传统行式数据库（如 PostgreSQL）的优势：
  #
  # 查询性能：
  # - 聚合查询快 10-100 倍（列式存储，只读取需要的列）
  # - 数据压缩比 10:1（节省 90% 存储空间）
  # - 支持并行查询（充分利用多核 CPU）
  #
  # 数据规模：
  # - 单表支持万亿行记录
  # - 单查询扫描 TB 级数据秒级响应
  # - 写入吞吐量达百万行/秒
  #
  # 成本效益：
  # - 相同性能下硬件成本降低 70%
  # - 存储成本降低 90%
  # - 运维复杂度低（无需分库分表）
  #
  # 📊 数据模型设计
  # ----------------------------------------------------------------------------
  # Langfuse 使用 MergeTree 引擎存储数据：
  # - 按时间分区（Partition）：便于删除历史数据
  # - 按主键排序（Order By）：加速常用查询
  # - 数据压缩（Compression）：使用 LZ4/ZSTD 算法
  # - 异步合并（Merge）：后台自动优化数据结构
  #
  # 🔧 性能调优建议
  # ----------------------------------------------------------------------------
  # 1. 内存配置：max_memory_usage = 80% 系统内存
  # 2. 磁盘选择：SSD（NVMe > SATA > HDD）
  # 3. CPU 核心：≥ 8 核（支持并行查询）
  # 4. 网络带宽：≥ 1Gbps（集群模式）
  #
  # ==========================================================================
  clickhouse:
    # 容器镜像：使用官方 ClickHouse Server 镜像
    # 版本选择：latest (最新版) 或指定版本如 25.9.4
    # 更新策略：定期检查新版本，评估后升级
    image: clickhouse/clickhouse-server:25.9.4
    
    # 重启策略：容器异常退出时自动重启
    restart: always
    
    # 使用非 root 用户运行（安全优秀做法）
    # ----------------------------------------------------------------------------
    # 说明：101:101 是 ClickHouse 镜像中预定义的 clickhouse 用户和组
    # 好处：
    # - 降低安全风险（容器逃逸后无法获取 root 权限）
    # - 符合 PCI-DSS、SOC 2 等安全标准
    # - 限制文件系统访问权限
    user: "101:101"
    
    # 环境变量配置
    # ----------------------------------------------------------------------------
    environment:
      # 默认数据库名称
      # 说明：ClickHouse 自带 default 数据库，Langfuse 使用此数据库
      CLICKHOUSE_DB: default
      
      # ClickHouse 用户名
      # 说明：建议生产环境创建专用用户，避免使用 default 用户
      # 权限要求：SELECT, INSERT, CREATE, ALTER, DELETE
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-clickhouse}
      
      # ClickHouse 密码
      # ⚠️ CHANGEME: 生产环境必须修改强密码！
      # 安全要求：≥ 16 字符，包含大小写字母、数字、特殊字符
      # 生成方式：openssl rand -base64 24
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
    
    # 数据持久化卷映射（Volume Mounting）
    # ----------------------------------------------------------------------------
    # 说明：将容器内路径映射到 Docker Volume，实现数据持久化
    volumes:
      # 数据文件存储（表数据、索引、元数据等）
      # 路径：/var/lib/clickhouse
      # 内容：*.bin (数据文件), *.mrk (标记文件), *.idx (索引文件)
      # 大小：随数据增长，预留 100GB - 1TB
      - langfuse_clickhouse_data:/var/lib/clickhouse
      
      # 日志文件存储（查询日志、错误日志、审计日志等）
      # 路径：/var/log/clickhouse-server
      # 内容：clickhouse-server.log, clickhouse-server.err.log
      # 大小：约 1-10GB，建议定期清理
      # 用途：问题排查、性能分析、安全审计
      - langfuse_clickhouse_logs:/var/log/clickhouse-server
    
    # 端口映射：仅绑定本机 127.0.0.1，禁止外网直接访问
    # ----------------------------------------------------------------------------
    # 安全考虑：ClickHouse 端口不应对外开放，避免以下风险：
    # - 未授权访问：密码被爆破
    # - SQL 注入攻击：恶意查询导致数据泄露
    # - 资源耗尽：恶意查询占满 CPU/内存
    # - 数据篡改：DELETE/DROP 操作破坏数据
    ports:
      # HTTP API 端口（用于 SQL 查询、数据导入、健康检查）
      # 协议：HTTP/HTTPS
      # 用途：Web 应用和 Worker 通过此端口访问
      # 示例查询：curl 'http://localhost:8123/?query=SELECT 1'
      - 127.0.0.1:8123:8123
      
      # 原生 TCP 协议端口（用于高性能数据传输和数据库迁移）
      # 协议：ClickHouse Native Protocol
      # 用途：clickhouse-client 命令行工具、数据库迁移
      # 优势：二进制协议，性能比 HTTP 高 30%
      - 127.0.0.1:9000:9000
    
    # 健康检查配置（Health Check）
    # ----------------------------------------------------------------------------
    # 说明：Docker 定期执行健康检查，判断服务是否可用
    # 用途：
    # - 自动重启：检查失败达到阈值后自动重启容器
    # - 依赖等待：depends_on 等待健康检查通过后启动
    # - 监控告警：集成监控系统（Prometheus, Datadog 等）
    healthcheck:
      # 检查命令：访问 /ping 端点，返回 "Ok." 表示服务正常
      # wget 参数：
      #   --no-verbose：减少输出
      #   --tries=1：只尝试一次
      #   --spider：不下载内容，只检查状态码
      # 退出码：0 = 健康，1 = 不健康
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
      
      # 检查间隔：每 5 秒执行一次健康检查
      interval: 5s
      
      # 超时时间：单次检查超过 5 秒视为失败
      timeout: 5s
      
      # 重试次数：连续失败 10 次后标记为 unhealthy
      # 计算：总失败时间 = interval * retries = 50秒
      retries: 10
      
      # 启动宽限期：容器启动后等待 1 秒再开始检查
      # 说明：ClickHouse 启动较快，1 秒足够
      start_period: 1s

  # ==========================================================================
  # MinIO 服务 - S3 兼容对象存储服务
  # ==========================================================================
  #
  # 📌 核心职责
  # ----------------------------------------------------------------------------
  # 1. 媒体文件存储：图片、音频、视频等多模态数据
  # 2. 事件数据归档：原始追踪事件的长期存储
  # 3. 批量导出文件：用户导出的 JSON/CSV 文件
  # 4. 备份数据存储：数据库备份和快照文件
  #
  # 🎯 为什么使用 MinIO？
  # ----------------------------------------------------------------------------
  # MinIO 是高性能的对象存储服务，完全兼容 AWS S3 API：
  #
  # 优势：
  # - 100% 兼容 S3 API：无缝迁移到 AWS/阿里云/腾讯云
  # - 高性能：读写速度可达 GB/s（取决于磁盘）
  # - 轻量级：单个二进制文件，部署简单
  # - 可扩展：支持分布式部署，EB 级存储
  # - 开源免费：Apache License 2.0
  #
  # 对比本地文件系统：
  # - 支持海量小文件（亿级文件数）
  # - 支持分布式访问（多节点读写）
  # - 支持数据冗余（纠删码/副本）
  # - 提供版本控制、生命周期管理
  #
  # 🔄 工作流程
  # ----------------------------------------------------------------------------
  # 上传流程：
  # 1. 客户端请求预签名上传 URL（Langfuse Web）
  # 2. 客户端直接上传文件到 MinIO（绕过 Langfuse）
  # 3. MinIO 返回上传成功确认
  # 4. 客户端通知 Langfuse 关联文件元数据
  #
  # 下载流程：
  # 1. 用户请求文件（Langfuse Web）
  # 2. Langfuse 生成预签名下载 URL（有效期 1 小时）
  # 3. 用户浏览器直接从 MinIO 下载文件
  #
  # 🔧 生产环境建议
  # ----------------------------------------------------------------------------
  # 1. 启用 TLS 加密（HTTPS）
  # 2. 配置 CORS 策略（限制来源域名）
  # 3. 启用访问日志和审计日志
  # 4. 配置对象生命周期（自动删除过期文件）
  # 5. 配置版本控制（支持文件恢复）
  # 6. 使用专用子账号（限制权限范围）
  #
  # ==========================================================================
  minio:
    # 容器镜像：使用官方 MinIO 镜像
    # 版本选择：latest (最新版) 或指定版本如 RELEASE.2025-09-07T16-13-09Z
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    
    # 重启策略：容器异常退出时自动重启
    restart: always
    
    # 自定义启动脚本
    # ----------------------------------------------------------------------------
    # 说明：使用 shell 脚本在启动前创建存储桶
    # 原因：MinIO 不会自动创建存储桶，需要手动创建或通过脚本初始化
    entrypoint: sh
    
    # 启动命令详解
    # ----------------------------------------------------------------------------
    # -c：执行后面的 shell 命令字符串
    # 
    # mkdir -p /data/langfuse：
    #   - 创建名为 'langfuse' 的存储桶目录
    #   - -p 参数：父目录不存在时自动创建
    #   - MinIO 使用文件系统目录模拟 S3 存储桶
    #
    # minio server：启动 MinIO 服务器
    #   - --address ":9000"：S3 API 监听在 9000 端口
    #   - --console-address ":9001"：Web 管理控制台监听在 9001 端口
    #   - /data：数据存储根目录（所有存储桶的父目录）
    #
    # 等价于：
    # $ mkdir -p /data/langfuse
    # $ minio server --address ":9000" --console-address ":9001" /data
    command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
    
    # 环境变量配置
    # ----------------------------------------------------------------------------
    environment:
      # MinIO 管理员用户名（Root User）
      # 说明：对应 AWS S3 的 Access Key ID
      # 用途：管理控制台登录、API 认证
      # 建议：生产环境修改为有意义的名称
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      
      # MinIO 管理员密码（Root Password）
      # 说明：对应 AWS S3 的 Secret Access Key
      # ⚠️ CHANGEME: 生产环境必须修改强密码！
      # 要求：最少 8 个字符
      # 安全建议：≥ 16 字符，包含大小写字母、数字、特殊字符
      # 生成方式：openssl rand -base64 16
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniosecret}
    
    # 端口映射
    # ----------------------------------------------------------------------------
    ports:
      # S3 API 端口 - 对外开放，供客户端直接上传/下载
      # 映射：主机 9090 端口 → 容器 9000 端口
      # 说明：
      # - 为什么映射到 9090：避免与可能的 PHP-FPM (9000) 冲突
      # - 为什么对外开放：支持客户端浏览器直接上传媒体文件
      # - 安全建议：配置防火墙规则，限制访问来源
      - 9090:9000
      
      # Web 管理控制台端口 - 仅本机访问
      # 映射：127.0.0.1:9091 → 容器 9001 端口
      # 访问地址：http://localhost:9091
      # 功能：
      # - 查看存储桶和文件
      # - 管理用户和权限
      # - 监控性能指标
      # - 配置生命周期规则
      # 安全：绑定 127.0.0.1，仅本机可访问
      - 127.0.0.1:9091:9001
    
    # 数据持久化卷映射
    # ----------------------------------------------------------------------------
    volumes:
      # 对象存储数据卷
      # 路径：/data
      # 内容：所有存储桶和文件
      # 结构：/data/{bucket_name}/{object_key}
      # 示例：/data/langfuse/media/2025/01/22/image.png
      # 大小：随数据增长，预留 50GB - 1TB
      - langfuse_minio_data:/data
    
    # 健康检查配置
    # ----------------------------------------------------------------------------
    # 说明：使用 MinIO Client (mc) 工具检测服务就绪状态
    healthcheck:
      # 检查命令：mc ready local
      # 说明：
      # - mc：MinIO Client 命令行工具（镜像内置）
      # - ready：检查服务是否就绪
      # - local：本地 MinIO 服务（无需配置 alias）
      # 返回：服务就绪返回 0，否则返回 1
      test: ["CMD", "mc", "ready", "local"]
      
      # 检查间隔：每 1 秒检查一次（快速启动）
      # 说明：MinIO 启动快，频繁检查加速就绪检测
      interval: 1s
      
      # 超时时间：单次检查超过 5 秒视为失败
      timeout: 5s
      
      # 重试次数：连续失败 5 次后标记为 unhealthy
      # 计算：总失败时间 = interval * retries = 5秒
      retries: 5
      
      # 启动宽限期：容器启动后等待 1 秒再开始检查
      start_period: 1s

  # ==========================================================================
  # Redis 服务 - 高性能内存数据库
  # ==========================================================================
  #
  # 📌 核心职责
  # ----------------------------------------------------------------------------
  # 1. 会话缓存：存储用户登录会话（NextAuth.js）
  # 2. 任务队列：缓冲追踪数据，实现异步处理（BullMQ）
  # 3. 速率限制：防止 API 滥用，保护系统稳定
  # 4. 分布式锁：协调多个 Worker 实例的任务分配
  # 5. 临时缓存：缓存热点数据，减轻数据库压力
  #
  # 🎯 为什么使用 Redis？
  # ----------------------------------------------------------------------------
  # Redis 是内存数据库，具有以下优势：
  #
  # 性能：
  # - 读写速度：10 万 QPS（单实例）
  # - 响应延迟：< 1ms（毫秒级）
  # - 吞吐量高：支持管道和批量操作
  #
  # 功能：
  # - 丰富数据结构：String, List, Set, Hash, ZSet
  # - 发布订阅：实时消息推送
  # - 事务支持：MULTI/EXEC 原子操作
  # - Lua 脚本：自定义原子操作
  #
  # 可靠性：
  # - 持久化：RDB 快照 + AOF 日志
  # - 主从复制：读写分离、高可用
  # - 哨兵模式：自动故障转移
  # - 集群模式：水平扩展
  #
  # 📊 数据持久化策略
  # ----------------------------------------------------------------------------
  # 本配置默认未启用持久化（纯缓存模式）：
  # - 优点：性能最佳，不写磁盘
  # - 缺点：重启后数据丢失
  # - 适用场景：会话、缓存、临时队列
  #
  # 如需启用持久化，在 command 中添加：
  # --save 900 1：900 秒内有 1 次写入则保存
  # --save 300 10：300 秒内有 10 次写入则保存
  # --save 60 10000：60 秒内有 10000 次写入则保存
  # --appendonly yes：启用 AOF 持久化
  #
  # 🔒 安全警告
  # ----------------------------------------------------------------------------
  # Redis 默认无密码，任何人都可访问！
  # ⚠️ 生产环境必须：
  # 1. 设置强密码（--requirepass）
  # 2. 绑定本机地址（127.0.0.1）
  # 3. 启用 TLS 加密
  # 4. 禁用危险命令（CONFIG, FLUSHALL 等）
  #
  # ==========================================================================
  redis:
    # 容器镜像：使用官方 Redis 7.x 镜像
    # 版本选择：7 (推荐) 或 6（稳定）
    # 说明：Redis 7 引入了 Redis Functions、ACL 改进等新特性
    image: docker.io/redis:7
    
    # 重启策略：容器异常退出时自动重启
    restart: always
    
    # Redis 启动命令配置
    # ----------------------------------------------------------------------------
    # 说明：使用命令行参数覆盖默认配置
    # 格式：command: > 表示多行命令，> 后的内容会被合并为一行
    #
    # 参数详解：
    # --requirepass ${REDIS_AUTH}：设置密码认证
    #   - 防止未授权访问
    #   - 所有命令执行前需先 AUTH 认证
    #   - ⚠️ CHANGEME: 生产环境必须修改强密码！
    #
    # 可选的其他参数（根据需求添加）：
    # --maxmemory 2gb：限制最大内存使用
    # --maxmemory-policy allkeys-lru：内存满时的淘汰策略
    # --save ""：禁用 RDB 持久化（纯缓存模式）
    # --appendonly yes：启用 AOF 持久化
    # --bind 127.0.0.1：仅监听本机地址（容器内无需设置）
    # --protected-mode yes：启用保护模式
    command: >
      --requirepass ${REDIS_AUTH:-myredissecret}
    
    # 端口映射
    # ----------------------------------------------------------------------------
    ports:
      # Redis 端口 - 仅绑定本机 127.0.0.1，禁止外网访问
      # 映射：127.0.0.1:6379 → 容器 6379 端口
      # 安全说明：
      # - 绑定 127.0.0.1 确保只有本机可访问
      # - 避免 Redis 暴露到公网（常见安全漏洞）
      # - 如需远程访问，使用 SSH 隧道或 VPN
      - 127.0.0.1:6379:6379
    
    # 健康检查配置
    # ----------------------------------------------------------------------------
    # 说明：使用 redis-cli ping 命令检测服务可用性
    healthcheck:
      # 检查命令：redis-cli ping
      # 说明：
      # - redis-cli：Redis 命令行客户端（镜像内置）
      # - ping：发送 PING 命令
      # - 响应：服务正常返回 "PONG"，否则报错
      # 注意：如果设置了密码，需要添加 -a 参数：
      #       redis-cli -a ${REDIS_AUTH} ping
      #       但这会在进程列表中暴露密码，不推荐
      # 当前配置：假设使用环境变量 REDISCLI_AUTH 传递密码
      test: ["CMD", "redis-cli", "ping"]
      
      # 检查间隔：每 3 秒检查一次
      interval: 3s
      
      # 超时时间：单次检查超过 10 秒视为失败
      # 说明：Redis 通常在 1ms 内响应，10秒超时已非常宽松
      timeout: 10s
      
      # 重试次数：连续失败 10 次后标记为 unhealthy
      # 计算：总失败时间 = interval * retries = 30秒
      retries: 10

  # ==========================================================================
  # PostgreSQL 服务 - 关系型主数据库
  # ==========================================================================
  #
  # 📌 核心职责
  # ----------------------------------------------------------------------------
  # 1. 用户管理：用户账户、权限、组织关系
  # 2. 项目配置：项目设置、API 密钥、团队成员
  # 3. 元数据存储：数据集、评估配置、提示词模板
  # 4. 事务处理：确保数据一致性（ACID 特性）
  #
  # 🎯 为什么使用 PostgreSQL？
  # ----------------------------------------------------------------------------
  # PostgreSQL 是世界上最先进的开源关系型数据库：
  #
  # 功能强大：
  # - 完整 ACID 事务支持
  # - 复杂查询（JOIN, 子查询, 窗口函数）
  # - JSON/JSONB 支持（NoSQL 特性）
  # - 全文搜索
  # - 地理空间数据（PostGIS）
  #
  # 可靠性高：
  # - 数据完整性约束（外键、检查约束）
  # - MVCC 并发控制（无读写锁冲突）
  # - WAL 日志（故障恢复）
  # - 流复制（高可用）
  #
  # 扩展性好：
  # - 支持存储过程和触发器
  # - 丰富的扩展生态（如 TimescaleDB, Citus）
  # - 支持分区表（水平分割）
  #
  # 📊 数据模型设计
  # ----------------------------------------------------------------------------
  # Langfuse 使用 PostgreSQL 存储核心业务数据：
  # - 用户表（users）：账户、邮箱、密码哈希
  # - 组织表（organizations）：组织信息、计费配置
  # - 项目表（projects）：项目设置、API 密钥
  # - 成员表（memberships）：用户-组织-项目关联
  # - 数据集表（datasets）：测试数据集定义
  # - 提示词表（prompts）：提示词模板和版本
  #
  # 🔧 性能优化建议
  # ----------------------------------------------------------------------------
  # 1. 索引优化：为常用查询字段创建索引
  # 2. 连接池：使用 PgBouncer 复用连接
  # 3. 定期维护：VACUUM, ANALYZE, REINDEX
  # 4. 配置调优：shared_buffers, work_mem, effective_cache_size
  #
  # ==========================================================================
  postgres:
    # 容器镜像：使用官方 PostgreSQL 镜像
    # 版本选择：17.7
    # 说明：PostgreSQL 版本号格式为主版本.次版本
    # 更新策略：跨主版本升级需要 pg_upgrade 或逻辑备份恢复
    image: docker.io/postgres:17.7
    
    # 重启策略：容器异常退出时自动重启
    restart: always
    
    # 健康检查配置
    # ----------------------------------------------------------------------------
    # 说明：使用 pg_isready 工具检测数据库是否可接受连接
    healthcheck:
      # 检查命令：pg_isready -U postgres
      # 说明：
      # - pg_isready：PostgreSQL 提供的连接检测工具
      # - -U postgres：指定用户名
      # - 返回码：0 = 可接受连接，1 = 拒绝连接，2 = 无响应
      # 注意：此命令只检查连接性，不验证密码
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      
      # 检查间隔：每 3 秒检查一次
      interval: 3s
      
      # 超时时间：单次检查超过 3 秒视为失败
      timeout: 3s
      
      # 重试次数：连续失败 10 次后标记为 unhealthy
      # 计算：总失败时间 = interval * retries = 30秒
      retries: 10
    
    # 环境变量配置
    # ----------------------------------------------------------------------------
    environment:
      # PostgreSQL 超级用户名
      # 说明：拥有所有权限的数据库管理员账户
      # 默认：postgres（PostgreSQL 默认超级用户）
      # 建议：生产环境可保持默认，通过防火墙限制访问
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      
      # PostgreSQL 超级用户密码
      # ⚠️ CHANGEME: 生产环境必须修改强密码！
      # 安全要求：≥ 16 字符，包含大小写字母、数字、特殊字符
      # 生成方式：openssl rand -base64 24
      # 注意：修改后需要同步更新 DATABASE_URL 环境变量
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      
      # 默认数据库名称
      # 说明：容器启动时自动创建的数据库
      # Langfuse 使用此数据库存储所有表
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      
      # 时区设置为 UTC（协调世界时）
      # 说明：统一使用 UTC 时区，避免时区转换问题
      # 好处：
      # - 跨地区部署一致性
      # - 夏令时无影响
      # - 日志时间统一
      # TZ：系统时区
      # PGTZ：PostgreSQL 时区
      TZ: UTC
      PGTZ: UTC
    
    # 端口映射
    # ----------------------------------------------------------------------------
    ports:
      # PostgreSQL 端口 - 仅绑定本机 127.0.0.1，禁止外网访问
      # 映射：127.0.0.1:5432 → 容器 5432 端口
      # 安全说明：
      # - PostgreSQL 包含敏感业务数据，不应暴露到公网
      # - 绑定 127.0.0.1 确保只有本机服务可访问
      # - 如需远程管理，使用 SSH 隧道或 VPN
      - 127.0.0.1:5432:5432
    
    # 数据持久化卷映射
    # ----------------------------------------------------------------------------
    volumes:
      # 数据库文件存储卷
      # 路径：/var/lib/postgresql/data
      # 内容：
      # - 表数据文件（base/）
      # - WAL 日志（pg_wal/）
      # - 配置文件（postgresql.conf, pg_hba.conf）
      # - 事务日志（pg_xact/）
      # 大小：约 100MB - 10GB（取决于用户数和项目数）
      # 
      # 重要性：⚠️ 此卷包含所有核心业务数据，必须定期备份！
      # 备份方式：
      # - 逻辑备份：pg_dump (适合小型数据库)
      # - 物理备份：pg_basebackup (适合大型数据库)
      # - 持续归档：WAL 归档 + 基础备份
      - langfuse_postgres_data:/var/lib/postgresql/data

# ============================================================================
# Docker Volumes 数据持久化配置
# ============================================================================
#
# 📘 什么是 Docker Volume？
# ----------------------------------------------------------------------------
# Docker Volume 是容器数据持久化的推荐方式：
# - 数据独立于容器生命周期（删除容器不会丢失数据）
# - 可在容器间共享数据
# - 支持备份和迁移
# - 性能优于绑定挂载（Bind Mount）
#
# 🗂️ 存储位置
# ----------------------------------------------------------------------------
# Linux/Mac：/var/lib/docker/volumes/{volume_name}/_data
# Windows：  \\wsl$\docker-desktop-data\data\docker\volumes\{volume_name}\_data
#
# 查看卷详情：
# $ docker volume inspect langfuse_postgres_data
#
# 🔍 Volume 驱动类型
# ----------------------------------------------------------------------------
# local（本地驱动）：
# - 默认驱动，存储在宿主机本地文件系统
# - 优点：简单、快速、无额外依赖
# - 缺点：单点故障、不支持跨主机
# - 适用：开发环境、小规模生产环境
#
# 其他驱动（生产环境推荐）：
# - NFS：网络文件系统，支持跨主机共享
# - Ceph：分布式存储，支持高可用
# - AWS EBS：云存储卷，支持快照和复制
# - Azure Disk：Azure 云存储卷
# - GlusterFS：开源分布式存储
#
# 📦 备份策略
# ----------------------------------------------------------------------------
# 方式 1：使用 docker run 备份卷
# $ docker run --rm -v langfuse_postgres_data:/data \
#              -v $(pwd):/backup \
#              alpine tar czf /backup/postgres_backup.tar.gz -C /data .
#
# 方式 2：直接备份数据库（推荐）
# $ docker compose exec postgres pg_dump -U postgres > backup.sql
# $ docker compose exec clickhouse clickhouse-client --query="BACKUP DATABASE default TO Disk('backups', 'backup_name')"
#
# 方式 3：使用第三方备份工具
# - Velero：Kubernetes 备份工具
# - Restic：快速增量备份
# - Duplicity：加密备份
#
# 🚀 数据迁移
# ----------------------------------------------------------------------------
# 迁移到新服务器：
# 1. 停止服务：docker compose down
# 2. 导出卷：docker run --rm -v volume_name:/data -v $(pwd):/backup alpine tar czf /backup/data.tar.gz -C /data .
# 3. 传输文件：scp data.tar.gz user@newserver:/path/
# 4. 导入卷：docker run --rm -v volume_name:/data -v /path:/backup alpine tar xzf /backup/data.tar.gz -C /data
# 5. 启动服务：docker compose up -d
#
# ⚠️ 重要提示
# ----------------------------------------------------------------------------
# 1. 删除容器时不要使用 -v 参数：
#    docker compose down     # ✅ 保留数据
#    docker compose down -v  # ❌ 删除所有数据！
#
# 2. 定期备份数据（建议每天备份）
# 3. 测试恢复流程（确保备份可用）
# 4. 监控磁盘空间（避免磁盘满）
# 5. 使用 RAID 或云存储提高可靠性
#
# ============================================================================
volumes:
  # PostgreSQL 数据卷
  # ----------------------------------------------------------------------------
  # 内容：用户、项目、配置等核心元数据
  # 大小：100MB - 10GB（取决于用户数和项目数）
  # 增长速度：缓慢（主要是元数据）
  # 重要性：⚠️⚠️⚠️ 极高！包含所有账户和配置数据
  # 备份频率：建议每天备份，重要变更后立即备份
  # 恢复优先级：P0（最高优先级）
  langfuse_postgres_data:
    driver: local
  
  # ClickHouse 数据卷
  # ----------------------------------------------------------------------------
  # 内容：追踪数据、指标数据、时间序列数据
  # 大小：1GB - 1TB+（取决于追踪数据量和保留时长）
  # 增长速度：快速（每天可能增长 GB 级别）
  # 重要性：⚠️⚠️ 高（分析数据，可通过事件数据重建）
  # 备份频率：建议每周备份，或配置数据保留策略
  # 恢复优先级：P1（次高优先级）
  # 
  # 存储优化建议：
  # - 配置数据保留策略（如保留 30/90 天数据）
  # - 定期删除历史数据（OPTIMIZE TABLE ... FINAL）
  # - 使用高性能 SSD（NVMe > SATA）
  langfuse_clickhouse_data:
    driver: local
  
  # ClickHouse 日志卷
  # ----------------------------------------------------------------------------
  # 内容：查询日志、错误日志、慢查询日志
  # 大小：100MB - 10GB（取决于日志级别和保留时长）
  # 增长速度：中等（取决于查询频率）
  # 重要性：⚠️ 中（用于调试和审计）
  # 备份频率：可选（主要用于问题排查）
  # 恢复优先级：P2（一般优先级）
  #
  # 日志管理建议：
  # - 定期清理旧日志（如保留 7 天）
  # - 配置日志轮转（logrotate）
  # - 集成日志收集系统（ELK, Loki 等）
  langfuse_clickhouse_logs:
    driver: local
  
  # MinIO 对象存储卷
  # ----------------------------------------------------------------------------
  # 内容：媒体文件、事件数据归档、批量导出文件
  # 大小：1GB - 10TB+（取决于媒体文件数量和大小）
  # 增长速度：快速（尤其是多模态数据场景）
  # 重要性：⚠️⚠️ 高（媒体文件难以重建）
  # 备份频率：建议每周备份，或使用 MinIO 复制功能
  # 恢复优先级：P1（次高优先级）
  #
  # 存储优化建议：
  # - 配置对象生命周期规则（自动删除过期文件）
  # - 启用对象版本控制（误删除可恢复）
  # - 使用对象标签分类管理
  # - 配置跨区域复制（高可用）
  # - 使用低成本存储类（如 Glacier，适合归档）
  #
  # 生产环境建议：
  # - 迁移到云对象存储（AWS S3, 阿里云 OSS, 腾讯云 COS）
  # - 成本更低、可靠性更高、无需维护
  langfuse_minio_data:
    driver: local

# ============================================================================
# 总结
# ============================================================================
#
# 📊 存储空间规划（参考值）
# ----------------------------------------------------------------------------
# 小规模（< 1000 traces/天）：
# - PostgreSQL: 1GB
# - ClickHouse: 10GB
# - MinIO: 10GB
# - 总计: 约 25GB
#
# 中规模（1000 - 10000 traces/天）：
# - PostgreSQL: 5GB
# - ClickHouse: 100GB
# - MinIO: 50GB
# - 总计: 约 200GB
#
# 大规模（> 10000 traces/天）：
# - PostgreSQL: 10GB
# - ClickHouse: 1TB+
# - MinIO: 500GB+
# - 总计: 约 2TB+
#
# 💰 成本优化建议
# ----------------------------------------------------------------------------
# 1. 配置数据保留策略（删除历史数据）
# 2. 启用数据压缩（ClickHouse 默认启用）
# 3. 使用对象存储生命周期规则
# 4. 定期监控磁盘使用情况
# 5. 考虑使用云存储（按需付费）
#
# 🔒 数据安全建议
# ----------------------------------------------------------------------------
# 1. 启用卷加密（Docker 企业版或云存储）
# 2. 配置访问权限（文件系统 ACL）
# 3. 实施 3-2-1 备份策略：
#    - 3 份副本
#    - 2 种存储介质
#    - 1 份异地备份
# 4. 定期测试恢复流程
# 5. 监控磁盘健康状态（SMART）
#
# ============================================================================
