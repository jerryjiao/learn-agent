# 深度研究助手 - 配置说明

本文档详细说明深度研究助手的各项配置选项和优秀做法。

## 目录

1. [LangGraph 配置](#langgraph-配置)
2. [Docker Compose 配置](#docker-compose-配置)
3. [环境变量配置](#环境变量配置)
4. [应用配置](#应用配置)
5. [性能调优](#性能调优)

---

## LangGraph 配置

### langgraph.json

这是 LangGraph Server 的核心配置文件，定义了图的入口和依赖。

```json
{
    "dockerfile_lines": [],
    "graphs": {
      "research_assistant": "./research_assistant.py:graph"
    },
    "python_version": "3.11",
    "dependencies": ["."]
}
```

#### 配置项说明

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `dockerfile_lines` | 额外的 Dockerfile 指令 | `["RUN apt-get install -y curl"]` |
| `graphs` | 图的名称和路径映射 | `{"graph_name": "./file.py:graph"}` |
| `python_version` | Python 版本 | `"3.11"` |
| `dependencies` | 依赖安装路径 | `["."]` 表示当前目录 |

#### 高级配置示例

```json
{
    "dockerfile_lines": [
        "RUN apt-get update && apt-get install -y curl",
        "ENV CUSTOM_VAR=value"
    ],
    "graphs": {
        "research_assistant": "./research_assistant.py:graph",
        "simple_assistant": "./simple.py:graph"
    },
    "python_version": "3.11",
    "dependencies": [
        ".",
        "git+https://github.com/user/repo.git"
    ]
}
```

---

## Docker Compose 配置

### docker-compose.yml

定义了三个服务：Redis、PostgreSQL 和 LangGraph API。

#### 服务说明

##### 1. langgraph-redis

**作用**：消息队列和缓存

```yaml
langgraph-redis:
    image: redis:6
    healthcheck:
        test: redis-cli ping
        interval: 5s
        timeout: 1s
        retries: 5
    ports:
        - "6380:6379"
```

**配置选项**：

| 选项 | 说明 | 推荐值 |
|------|------|--------|
| `image` | Redis 镜像版本 | `redis:6` 或 `redis:7` |
| `ports` | 端口映射 | `"6380:6379"` |
| `healthcheck.interval` | 健康检查间隔 | `5s` |
| `healthcheck.retries` | 重试次数 | `5` |

**性能调优**：

```yaml
langgraph-redis:
    image: redis:6
    command: redis-server --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
        - redis-data:/data
```

##### 2. langgraph-postgres

**作用**：状态持久化存储

```yaml
langgraph-postgres:
    image: postgres:16
    ports:
        - "5433:5432"
    environment:
        POSTGRES_DB: postgres
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
    volumes:
        - langgraph-data:/var/lib/postgresql/data
```

**配置选项**：

| 选项 | 说明 | 推荐值 |
|------|------|--------|
| `image` | PostgreSQL 版本 | `postgres:16` |
| `POSTGRES_DB` | 数据库名称 | `postgres` |
| `POSTGRES_USER` | 用户名 | `postgres` |
| `POSTGRES_PASSWORD` | 密码 | 生产环境使用强密码 |

**安全加固**：

```yaml
langgraph-postgres:
    image: postgres:16
    environment:
        POSTGRES_DB: research_db
        POSTGRES_USER: research_user
        POSTGRES_PASSWORD: ${DB_PASSWORD}  # 从环境变量读取
        POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=zh_CN.UTF-8"
    volumes:
        - postgres-data:/var/lib/postgresql/data
```

##### 3. langgraph-api

**作用**：LangGraph Server API 服务

```yaml
langgraph-api:
    image: "research-assistant-image"
    ports:
        - "8124:8000"
    depends_on:
        langgraph-redis:
            condition: service_healthy
        langgraph-postgres:
            condition: service_healthy
    environment:
        REDIS_URI: redis://langgraph-redis:6379
        POSTGRES_URI: postgres://postgres:postgres@langgraph-postgres:5432/postgres?sslmode=disable
```

**配置选项**：

| 选项 | 说明 | 示例 |
|------|------|------|
| `image` | Docker 镜像名称 | `research-assistant-image` |
| `ports` | 端口映射 | `"8124:8000"` |
| `REDIS_URI` | Redis 连接字符串 | `redis://host:6379` |
| `POSTGRES_URI` | PostgreSQL 连接字符串 | `postgres://user:pass@host:5432/db` |

**资源限制**：

```yaml
langgraph-api:
    image: "research-assistant-image"
    deploy:
        resources:
            limits:
                cpus: '2'
                memory: 4G
            reservations:
                cpus: '1'
                memory: 2G
    restart: unless-stopped
```

---

## 环境变量配置

### .env 文件

存储敏感信息和配置参数。

#### 必需变量

```bash
# OpenAI API 配置
OPENAI_API_KEY="sk-your-key-here"
```

#### 可选变量

```bash
# OpenAI API 自定义地址（国内代理等）
OPENAI_BASE_URL="https://api.openai.com/v1"

# Tavily 搜索 API
TAVILY_API_KEY="tvly-your-key-here"

# LangSmith 追踪（监控和调试）
LANGSMITH_API_KEY="lsv2-your-key-here"
LANGSMITH_TRACING="true"
LANGSMITH_PROJECT="ResearchAssistant"
```

#### 高级配置

```bash
# 数据库配置
POSTGRES_USER="custom_user"
POSTGRES_PASSWORD="strong_password"
POSTGRES_DB="research_db"

# Redis 配置
REDIS_PASSWORD="redis_password"

# 应用配置
LOG_LEVEL="INFO"
MAX_CONCURRENT_REQUESTS="10"
REQUEST_TIMEOUT="300"
```

### 安全优秀做法

1. **不要提交 .env 文件到版本控制**

```bash
echo ".env" >> .gitignore
```

2. **使用强密码**

```bash
# 生成随机密码
openssl rand -base64 32
```

3. **使用密钥管理服务**（生产环境）

- AWS Secrets Manager
- Azure Key Vault
- HashiCorp Vault

---

## 应用配置

### configuration.py

定义应用级别的配置参数。

```python
@dataclass(kw_only=True)
class Configuration:
    # 研究主题
    topic: str = "人工智能的发展趋势"
    
    # 分析师数量上限
    max_analysts: int = 3
    
    # 访谈最大轮次
    max_interview_turns: int = 2
    
    # 是否启用人机协同
    enable_human_feedback: bool = True
```

#### 配置说明

| 参数 | 说明 | 推荐值 | 影响 |
|------|------|--------|------|
| `topic` | 研究主题 | 用户指定 | 决定研究方向 |
| `max_analysts` | 分析师数量 | 2-5 | 影响研究深度和成本 |
| `max_interview_turns` | 访谈轮次 | 2-3 | 影响信息详细程度 |
| `enable_human_feedback` | 人机协同 | True | 是否需要人工审核 |

#### 运行时配置

在调用时可以覆盖默认配置：

```python
config = {
    "configurable": {
        "topic": "区块链技术",
        "max_analysts": 4,
        "max_interview_turns": 3,
        "enable_human_feedback": False
    }
}

result = await client.runs.stream(..., config=config)
```

---

## 性能调优

### 1. 并发控制

#### 分析师数量

- **少量（2-3）**：适合快速研究，成本低
- **中等（3-5）**：平衡深度和效率
- **大量（5+）**：深度研究，成本高，时间长

#### 访谈轮次

- **1轮**：基础信息收集
- **2轮**：推荐配置
- **3+轮**：深度挖掘

### 2. API 调用优化

#### 限流配置

```python
# 在 docker-compose.yml 中添加
environment:
    MAX_CONCURRENT_REQUESTS: "10"
    RATE_LIMIT_PER_MINUTE: "60"
```

#### Token 优化

```python
# 使用更小的模型
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

# 限制上下文长度
doc_content_chars_max = 5000
```

### 3. 缓存策略

#### Redis 缓存配置

```yaml
langgraph-redis:
    command: >
        redis-server
        --maxmemory 4gb
        --maxmemory-policy allkeys-lru
        --save 900 1
        --save 300 10
```

#### 应用层缓存

```python
# 缓存搜索结果
@lru_cache(maxsize=100)
def search_cached(query: str):
    return tavily_search.invoke(query)
```

### 4. 数据库优化

#### PostgreSQL 调优

```sql
-- 在 docker-compose.yml 中添加初始化脚本
volumes:
    - ./init.sql:/docker-entrypoint-initdb.d/init.sql
```

```sql
-- init.sql
-- 增加连接数
ALTER SYSTEM SET max_connections = 200;

-- 优化查询性能
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
```

### 5. 监控和日志

#### 启用详细日志

```yaml
langgraph-api:
    environment:
        LOG_LEVEL: "DEBUG"
        LANGSMITH_TRACING: "true"
```

#### 查看性能指标

```bash
# 查看 API 响应时间
docker compose logs langgraph-api | grep "response_time"

# 监控资源使用
docker stats
```

---

## 配置模板

### 开发环境配置

```yaml
# docker-compose.dev.yml
services:
    langgraph-api:
        image: "research-assistant-image"
        environment:
            LOG_LEVEL: "DEBUG"
            MAX_ANALYSTS: "2"
            MAX_INTERVIEW_TURNS: "1"
        volumes:
            - ./research_assistant.py:/app/research_assistant.py
```

### 生产环境配置

```yaml
# docker-compose.prod.yml
services:
    langgraph-api:
        image: "research-assistant-image:v1.0"
        deploy:
            replicas: 3
            resources:
                limits:
                    cpus: '2'
                    memory: 4G
        environment:
            LOG_LEVEL: "INFO"
            MAX_CONCURRENT_REQUESTS: "50"
        restart: always
```

---

## 故障排查

### 常见配置问题

1. **API 密钥无效**
   - 检查 `.env` 文件
   - 确认密钥格式正确

2. **端口冲突**
   - 修改 `docker-compose.yml` 中的端口映射
   - 使用 `netstat -an | findstr :8124` 检查端口

3. **资源不足**
   - 增加 Docker 资源限制
   - 减少分析师数量和访谈轮次

4. **连接超时**
   - 增加健康检查超时时间
   - 检查网络配置

---

## 参考资源

- [LangGraph Configuration](https://langchain-ai.github.io/langgraph/concepts/langgraph_cli/)
- [Docker Compose File Reference](https://docs.docker.com/compose/compose-file/)
- [PostgreSQL Configuration](https://www.postgresql.org/docs/current/runtime-config.html)
- [Redis Configuration](https://redis.io/docs/management/config/)

---

**最后更新**: 2025-10-01

